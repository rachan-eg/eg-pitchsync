# Docker Compose for Pitch-Sync Engine
# Note: 'version' key removed - deprecated in modern Docker Compose
# Database is NOT persisted - fresh DB on each deployment

services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - GENERATED_DIR=/app/generated
      # Database stored in container - wiped on each deployment for fresh start
      - DATABASE_URL=sqlite:////app/gum_app.db
      - PYTHONPATH=/app
      - WORKERS=${WORKERS:-4}
      # Higher timeout for long AI calls (Red Team eval can take 30s+)
      - GUNICORN_TIMEOUT=120
      # Mode flags
      - DEBUG=${DEBUG:-false}
      - TEST_MODE=${TEST_MODE:-false}
      # Keycloak SSO Configuration - Explicitly passed for reliability
      - KEYCLOAK_SERVER_URL=${KEYCLOAK_SERVER_URL}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      # AWS Credentials - Passed from host environment ONLY if they exist (local dev).
      # On EC2, these won't be set on host, so they won't exist in container, allowing IAM Role fallback.
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - AWS_SESSION_TOKEN
      - AWS_REGION=${AWS_REGION:-eu-central-1}
      - AWS_DEFAULT_REGION=${AWS_REGION:-eu-central-1}
    volumes:
      - generated_data:/app/generated
      # Mount .env file so Python can read it directly (read-only)
      - ./.env:/app/.env:ro
      # Mount vault for phase definitions and assets (read-only)
      - ./backend/vault:/app/backend/vault:ro
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: always

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=/api
        - VITE_KEYCLOAK_URL=${VITE_KEYCLOAK_URL}
        - VITE_KEYCLOAK_REALM=${VITE_KEYCLOAK_REALM}
        - VITE_KEYCLOAK_CLIENT_ID=${VITE_KEYCLOAK_CLIENT_ID}
        - VITE_ALLOW_BYPASS=${VITE_ALLOW_BYPASS}
    ports:
      - "80:80"
    # Removed redundant mount - handled by nginx proxy to backend
    # volumes:
    #   - generated_data:/usr/share/nginx/html/generated
    depends_on:
      backend:
        condition: service_healthy
    restart: always

volumes:
  generated_data:
